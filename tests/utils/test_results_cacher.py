#!/usr/bin/env python
""" Tests models."""

import pytest

from utils.results_cacher import winrate_player, most_popular_player


def test_winrate_player():
    """ Tests winrate player results."""
    expected = {
        "1": 0.467,
        "2": 0.492,
        "3": 0.509,
        "4": 0.500,
        "5": 0.510,
        "6": 0.441,
        "7": 0.395,
        "8": 0.485,
        "9": 0.354,
        "10": 0.510,
        "11": 0.507,
        "12": 0.493,
        "13": 0.461,
        "14": 0.502,
        "15": 0.418,
        "16": 0.485,
        "17": 0.424,
        "18": 0.533,
        "19": 0.562,
        "20": 0.488,
        "21": 0.498,
        "22": 0.405,
        "23": 0.523,
        "24": 0.555,
        "25": 0.418,
        "26": 0.498,
        "27": 0.428,
        "28": 0.463,
        "29": 0.495,
        "30": 0.553,
        "31": 0.395,
        "32": 0.501,
        "33": 0.385,
        "34": 0.441,
        "35": 0.437,
        "36": 0.569,
        "37": 0.454,
    }
    timebox = (
        1628294400,
        1628380800,
    )
    team_size = "1v1"
    map_category = "Arena"
    civs = winrate_player(timebox, team_size, map_category)
    assert len(civs) == len(expected)
    for civ in civs:
        assert float(civ.pct) == expected[civ.civ_id]


def test_most_popular_player_compound():
    """ Tests popularity player results."""
    expected = {
        "28:36": 2.5,
        "36:37": 0.5,
        "14:24": 3.0,
        "23:3": 3.0,
        "1:3": 20.75,
        "13:19": 1.0,
        "17:30": 4.0,
        "12:3": 9.666666666666668,
        "27:30": 1.0,
        "27:37": 2.0,
        "1:2": 44.199999999999996,
        "14:3": 3.5,
        "20:3": 1.75,
        "28:6": 4.25,
        "24:3": 2.5,
        "27:29": 1.0,
        "14:8": 1.0,
        "12:14": 2.5,
        "17:3": 5.5,
        "13:20": 1.0,
        "18:23": 1.5,
        "1:1": 2.0,
        "2:32": 6.0,
        "10:25": 2.0,
        "1:36": 7.5,
        "2:6": 7.0,
        "3:32": 2.2,
        "12:24": 2.5,
        "16:35": 5.5,
        "12:31": 4.0,
        "30:6": 1.0,
        "2:26": 1.0,
        "15:23": 0.25,
        "10:36": 3.0,
        "28:3": 6.75,
        "14:15": 1.2,
        "19:3": 4.75,
        "16:34": 5.333333333333333,
        "25:35": 5.5,
        "31:35": 4.0,
        "1:7": 4.5,
        "12:8": 3.5,
        "16:8": 1.75,
        "1:15": 3.0,
        "15:34": 4.0,
        "11:25": 3.0,
        "19:35": 3.0,
        "13:16": 4.0,
        "2:35": 8.0,
        "11:34": 3.0,
        "1:35": 12.5,
        "13:35": 3.7,
        "1:16": 6.0,
        "15:8": 2.6666666666666665,
        "3:6": 2.0,
        "29:36": 3.5,
        "14:28": 3.5,
        "16:4": 3.0,
        "14:34": 3.5,
        "2:7": 7.0,
        "21:22": 2.0,
        "29:8": 1.0,
        "32:4": 2.0,
        "10:3": 8.5,
        "23:27": 1.0,
        "1:10": 6.166666666666667,
        "16:36": 5.0,
        "11:23": 2.5,
        "29:32": 1.0,
        "32:35": 3.0,
        "25:30": 0.5,
        "12:2": 18.666666666666664,
        "28:35": 3.5,
        "25:4": 5.0,
        "3:34": 7.0,
        "13:7": 1.0,
        "13:32": 3.3333333333333335,
        "13:14": 3.0,
        "13:2": 8.2,
        "1:26": 2.0,
        "3:7": 7.666666666666666,
        "10:31": 1.5,
        "10:2": 11.499999999999998,
        "17:22": 4.5,
        "15:19": 1.8333333333333333,
        "23:7": 3.5,
        "23:26": 1.0,
        "24:34": 2.5,
        "35:37": 2.0,
        "10:27": 1.5833333333333335,
        "10:29": 1.75,
        "15:21": 1.0,
        "3:36": 6.5,
        "12:19": 3.0,
        "15:20": 0.3333333333333333,
        "15:3": 7.333333333333333,
        "1:12": 7.0,
        "11:2": 8.25,
        "23:24": 2.0,
        "14:27": 0.2,
        "14:32": 3.4,
        "14:35": 3.2,
        "1:13": 4.833333333333333,
        "17:8": 2.0,
        "12:4": 3.5,
        "10:22": 2.166666666666667,
        "3:4": 9.5,
        "14:36": 2.0,
        "10:14": 4.0,
        "33:36": 1.0,
        "18:8": 4.0,
        "3:31": 2.8333333333333335,
        "11:4": 5.5,
        "32:34": 2.333333333333333,
        "24:37": 1.0,
        "31:4": 4.0,
        "21:23": 2.0,
        "29:35": 4.0,
        "10:12": 5.666666666666666,
        "15:4": 5.0,
        "13:8": 2.2,
        "22:7": 2.0,
        "1:23": 2.0,
        "14:25": 3.0,
        "13:36": 1.6666666666666665,
        "21:31": 1.5,
        "13:30": 0.5,
        "24:5": 0.5,
        "2:3": 26.25,
        "11:13": 1.0,
        "15:32": 2.5,
        "1:25": 2.5,
        "3:5": 1.6666666666666665,
        "16:2": 10.2,
        "16:17": 3.0,
        "10:34": 2.5,
        "10:8": 5.0,
        "17:2": 7.2,
        "4:7": 3.5,
        "25:34": 3.0,
        "20:37": 1.0,
        "32:7": 1.0,
        "2:8": 6.5,
        "25:9": 1.0,
        "13:34": 5.4,
        "10:32": 4.5,
        "1:32": 5.333333333333334,
        "1:11": 2.0,
        "21:34": 1.0,
        "21:28": 2.6666666666666665,
        "3:33": 2.0,
        "14:6": 3.0,
        "16:22": 3.5,
        "3:9": 2.0,
        "1:9": 2.6,
        "12:28": 5.5,
        "24:4": 3.0,
        "11:22": 1.0,
        "19:30": 1.2,
        "13:3": 2.8666666666666667,
        "13:5": 2.7,
        "10:37": 1.0,
        "1:4": 10.0,
        "4:5": 1.5,
        "2:37": 3.0,
        "3:8": 5.0,
        "3:35": 9.0,
        "23:28": 2.0,
        "10:13": 5.5,
        "2:30": 2.0,
        "37:4": 1.0,
        "13:31": 0.5,
        "15:36": 3.0,
        "23:4": 2.6666666666666665,
        "22:4": 3.25,
        "11:35": 2.333333333333333,
        "2:33": 4.0,
        "2:25": 6.333333333333333,
        "23:36": 1.0,
        "23:34": 1.0,
        "19:2": 9.0,
        "14:19": 2.0,
        "22:25": 4.666666666666667,
        "12:37": 1.0,
        "25:3": 6.0,
        "17:23": 1.1666666666666667,
        "13:28": 2.5,
        "28:8": 2.0,
        "11:3": 3.0,
        "17:5": 2.0,
        "3:3": 3.5,
        "7:8": 2.0,
        "1:27": 1.5,
        "27:31": 0.5,
        "1:20": 6.0,
        "2:5": 2.0,
        "2:24": 4.0,
        "31:6": 1.5,
        "18:35": 1.0,
        "23:31": 1.0,
        "1:21": 1.6666666666666665,
        "21:4": 2.5,
        "12:15": 2.833333333333333,
        "12:23": 4.0,
        "37:6": 1.0,
        "2:28": 5.5,
        "16:21": 0.3333333333333333,
        "2:21": 4.916666666666666,
        "35:4": 2.0,
        "36:5": 2.0,
        "17:21": 1.0,
        "24:25": 1.0,
        "4:9": 0.8333333333333333,
        "35:7": 3.0,
        "11:24": 1.0,
        "28:37": 2.0,
        "10:4": 6.5,
        "19:25": 1.6666666666666665,
        "28:7": 3.0,
        "10:35": 5.5,
        "15:27": 2.0,
        "2:9": 3.0,
        "11:15": 2.25,
        "1:8": 5.083333333333333,
        "21:32": 3.25,
        "17:7": 2.0,
        "12:16": 2.5,
        "10:7": 1.0,
        "28:9": 0.5,
        "35:9": 0.5,
        "15:2": 11.100000000000001,
        "21:7": 2.0,
        "23:6": 2.5,
        "2:31": 3.333333333333333,
        "2:29": 4.0,
        "10:30": 1.0,
        "17:33": 1.0,
        "15:9": 1.0,
        "2:36": 5.7,
        "14:4": 7.0,
        "29:6": 2.0,
        "27:36": 2.0,
        "12:6": 1.0,
        "18:2": 7.333333333333333,
        "21:37": 1.3333333333333333,
        "2:4": 8.5,
        "3:37": 2.0,
        "14:26": 1.0,
        "11:12": 2.0,
        "17:29": 2.5,
        "1:22": 3.3333333333333335,
        "14:7": 2.0,
        "25:28": 3.0,
        "10:11": 3.0,
        "2:2": 1.0,
        "10:28": 7.833333333333333,
        "29:34": 1.3333333333333333,
        "24:31": 0.3333333333333333,
        "12:17": 1.0,
        "15:22": 2.0,
        "19:37": 1.0,
        "34:36": 1.0,
        "12:34": 4.5,
        "2:22": 4.0,
        "30:8": 1.0,
        "28:4": 4.666666666666667,
        "35:6": 5.333333333333333,
        "25:5": 1.0,
        "19:9": 1.0,
        "30:5": 2.0,
        "12:36": 4.0,
        "34:8": 1.0,
        "12:27": 2.0,
        "15:5": 2.0,
        "27:4": 1.0,
        "15:24": 1.0,
        "27:3": 2.0,
        "1:24": 2.5,
        "34:6": 1.0,
        "19:28": 3.0,
        "18:19": 1.0,
        "25:32": 3.8,
        "2:34": 5.666666666666667,
        "15:35": 1.3333333333333333,
        "1:14": 4.666666666666666,
        "6:8": 1.5,
        "32:9": 1.0,
        "19:8": 1.0,
        "30:35": 3.0,
        "17:6": 2.5,
        "2:20": 2.0,
        "18:22": 2.0,
        "2:27": 3.3333333333333335,
        "23:32": 1.8333333333333335,
        "28:31": 2.0,
        "16:23": 0.5,
        "12:21": 2.5,
        "18:36": 1.0,
        "16:3": 4.0,
        "14:23": 1.0,
        "17:19": 1.5,
        "35:8": 3.0,
        "16:28": 1.0,
        "13:9": 0.5,
        "10:5": 2.0,
        "15:30": 2.0,
        "12:30": 1.5,
        "1:34": 3.0,
        "25:7": 1.0,
        "18:5": 1.0,
        "13:6": 2.0,
        "34:7": 2.0,
        "25:36": 1.5,
        "2:23": 5.0,
        "30:30": 0.5,
        "1:5": 2.0,
        "34:5": 1.0,
        "31:32": 2.0,
        "10:16": 2.0,
        "32:6": 1.0,
        "22:3": 1.25,
        "12:33": 1.0,
        "1:17": 2.333333333333333,
        "11:14": 0.3333333333333333,
        "11:28": 1.3333333333333333,
        "13:23": 1.0,
        "18:7": 1.0,
        "16:32": 2.0,
        "17:35": 1.0,
        "5:8": 0.5,
        "15:29": 1.5,
        "1:37": 2.3333333333333335,
        "29:9": 1.0,
        "11:17": 1.0,
        "11:19": 3.0,
        "15:7": 2.0,
        "11:33": 1.0,
        "10:17": 2.0,
        "7:9": 1.5,
        "22:27": 1.0,
        "1:18": 3.5,
        "14:37": 1.0,
        "1:28": 5.0,
        "1:31": 1.3333333333333333,
        "10:18": 2.0,
        "17:36": 2.0,
        "20:32": 1.0,
        "11:6": 2.5,
        "13:18": 1.0,
        "36:6": 2.0,
        "25:26": 2.0,
        "30:34": 1.0,
        "28:32": 2.0,
        "11:16": 1.4,
        "12:35": 4.5,
        "27:33": 1.0,
        "24:36": 1.0,
        "17:4": 4.0,
        "15:17": 2.5,
        "10:10": 1.0,
        "12:18": 0.5,
        "15:37": 1.0,
        "28:5": 0.5,
        "17:18": 3.0,
        "22:31": 0.5,
        "26:33": 2.0,
        "14:2": 2.0,
        "13:22": 1.0,
        "12:25": 0.3333333333333333,
        "20:36": 0.3333333333333333,
        "11:8": 2.0,
        "14:22": 1.0,
        "13:4": 3.0,
        "12:7": 5.0,
        "11:29": 1.5,
        "16:33": 1.5,
        "12:13": 6.0,
        "36:7": 5.0,
        "31:5": 1.0,
        "17:31": 2.0,
        "12:26": 1.0,
        "22:37": 1.0,
        "20:6": 1.0,
        "30:36": 1.0,
        "4:6": 4.0,
        "34:35": 4.0,
        "13:26": 1.0,
        "21:35": 1.0,
        "32:5": 0.5,
        "22:28": 0.5,
        "6:7": 5.0,
        "20:34": 1.0,
        "17:25": 1.0,
        "18:3": 0.3333333333333333,
        "17:28": 1.3333333333333333,
        "24:35": 2.0,
        "22:29": 1.0,
        "19:31": 1.0,
        "14:14": 1.0,
        "23:9": 1.0,
        "27:35": 1.0,
        "20:35": 2.0,
        "34:4": 2.0,
        "10:24": 1.0,
        "20:24": 1.0,
        "16:7": 1.3333333333333333,
        "20:31": 1.0,
        "10:20": 1.25,
        "21:27": 1.0,
        "22:34": 1.0,
        "18:28": 1.0,
        "10:23": 2.0,
        "18:32": 1.0,
        "15:31": 1.0,
        "26:34": 1.0,
        "31:8": 1.0,
        "19:21": 0.3333333333333333,
        "32:37": 1.0,
        "25:31": 1.0,
        "24:7": 1.0,
        "14:31": 1.0,
        "8:9": 1.0,
        "17:34": 3.0,
        "24:32": 1.0,
        "20:4": 1.0,
        "33:4": 1.0,
        "16:30": 1.0,
        "15:18": 0.5,
        "22:6": 1.0,
        "14:21": 1.0,
        "28:34": 2.0,
        "28:30": 1.0,
        "4:8": 1.0,
        "10:21": 0.3333333333333333,
        "36:4": 1.6666666666666665,
        "5:7": 0.5,
        "20:25": 1.0,
        "14:16": 2.0,
        "32:8": 1.0,
        "18:34": 2.0,
        "12:32": 1.0,
        "19:26": 0.5,
        "26:6": 0.5,
        "26:4": 1.0,
        "11:20": 1.0,
        "35:5": 2.0,
        "12:22": 2.0,
        "19:34": 0.5,
        "14:20": 1.0,
        "13:15": 2.0,
        "34:34": 1.0,
        "20:28": 1.0,
        "10:19": 1.0,
        "10:6": 0.5,
        "21:25": 1.0,
        "23:30": 1.0,
        "1:6": 1.0,
        "31:9": 0.6666666666666666,
        "16:6": 0.3333333333333333,
        "29:3": 1.0,
        "6:6": 1.0,
        "11:11": 1.0,
        "1:29": 1.0,
        "33:33": 1.0,
        "36:9": 0.5,
        "28:28": 1.0,
        "29:4": 1.0,
        "10:15": 0.5,
        "35:36": 1.0,
        "19:4": 2.0,
        "36:8": 0.5,
        "19:6": 1.0,
        "20:7": 1.0,
        "10:26": 1.0,
        "33:7": 1.0,
        "16:25": 1.0,
        "17:32": 1.0,
        "15:28": 0.5,
        "23:35": 1.0,
        "4:4": 1.0,
        "22:23": 1.0,
        "14:17": 1.0,
    }
    timebox = (
        1628294400,
        1628380800,
    )
    team_size = "2v2"
    map_category = "Arena"
    civs = most_popular_player(timebox, team_size, map_category, False)
    assert len(civs) == len(expected)
    for civ in civs:
        assert pytest.approx(civ.score) == expected[civ.civ_id]


def test_most_popular_player_basic():
    """ Tests popularity player results."""
    expected = {
        "31": 35.11666666666666,
        "7": 80.03333333333333,
        "33": 33.608333333333334,
        "34": 71.87777777777778,
        "36": 85.78333333333333,
        "14": 91.88376623376624,
        "2": 238.66904761904763,
        "15": 95.87692307692308,
        "12": 101.1456349206349,
        "10": 148.2845238095238,
        "11": 51.476923076923065,
        "29": 70.55000000000001,
        "5": 40.61230158730159,
        "32": 71.06666666666668,
        "16": 69.46785714285714,
        "18": 56.226190476190474,
        "1": 187.51961926961926,
        "9": 22.09444444444444,
        "4": 123.46783216783219,
        "17": 53.25,
        "13": 75.95,
        "28": 107.4202380952381,
        "25": 91.76666666666667,
        "8": 50.9,
        "27": 35.7,
        "19": 40.75000000000001,
        "20": 22.783333333333335,
        "30": 26.976190476190474,
        "35": 111.24747474747474,
        "23": 40.25,
        "22": 38.75396825396826,
        "24": 53.05992063492063,
        "3": 146.31992174492171,
        "21": 27.65,
        "6": 60.027777777777786,
        "26": 34.43333333333333,
        "37": 21.000000000000004,
    }
    timebox = (
        1628294400,
        1628380800,
    )
    team_size = "1v1"
    map_category = "Arena"
    civs = most_popular_player(timebox, team_size, map_category, True)
    assert len(civs) == len(expected)
    for civ in civs:
        assert civ.score == expected[civ.civ_id]
